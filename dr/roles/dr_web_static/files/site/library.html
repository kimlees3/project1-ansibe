<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Justic - Library</title>
  <link rel="stylesheet" href="css/style.css">

  <script>
    const token = localStorage.getItem("access_token");
    if (!token) {
      window.location.href = "index.html";
    }
  </script>
</head>
<body>

  <!-- 우측 상단 메뉴 -->
  <div class="top-menu">
    <div class="menu-btn" id="menuBtn">
      <span></span>
    </div>

    <div class="menu-dropdown" id="menuDropdown">
      <a href="#" id="goMainBtn">영상 생성하러 가기</a>
      <a href="#" id="logoutBtn">로그아웃</a>
    </div>
  </div>

  <!-- 라이브러리 -->
  <div class="library-container">
    <h2 class="library-title">영상 라이브러리</h2>
    <div class="video-grid" id="videoGrid"></div>
  </div>

  <!-- 메뉴 스크립트 -->
  <script>
    const menuBtn = document.getElementById("menuBtn");
    const menuDropdown = document.getElementById("menuDropdown");
    const logoutBtn = document.getElementById("logoutBtn");
    const goMainBtn = document.getElementById("goMainBtn");

    menuBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      menuDropdown.classList.toggle("show");
    });

    goMainBtn.addEventListener("click", () => {
      window.location.href = "main.html";
    });

    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("access_token");
      window.location.href = "index.html";
    });

    document.addEventListener("click", () => {
      menuDropdown.classList.remove("show");
    });
  </script>

  <!-- 라이브러리 로직 -->
  <script>
    const videoGrid = document.getElementById("videoGrid");

    // ✅ 썸네일을 Authorization 포함해서 가져온 뒤 img에 꽂기
    async function loadThumbIntoImg(imgEl, taskId) {
      try {
        const res = await fetch(`/api/video/thumb/${taskId}.jpg?ts=${Date.now()}`, {
          headers: { "Authorization": `Bearer ${token}` }
        });

        if (!res.ok) throw new Error("thumb fetch failed");

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        imgEl.src = url;

        // 메모리 정리용 (이미지 로드 후 revoke)
        imgEl.onload = () => URL.revokeObjectURL(url);

      } catch (e) {
        // 썸네일 실패하면 검은 박스 유지 (이미지 숨김)
        imgEl.style.display = "none";
      }
    }

    // 1️⃣ 내 영상 목록 불러오기
    async function loadLibrary() {
      try {
        const res = await fetch("/api/video/list", {
          headers: { "Authorization": `Bearer ${token}` }
        });

        if (!res.ok) throw new Error("라이브러리 조회 실패");

        const data = await res.json();

        if (!data.videos || data.videos.length === 0) {
          videoGrid.innerHTML = "<p>아직 생성된 영상이 없습니다.</p>";
          return;
        }

        videoGrid.innerHTML = "";

        data.videos.forEach(video => {
          const card = document.createElement("div");
          card.className = "video-card";

          const img = document.createElement("img");
          img.className = "thumb-img";
          img.alt = "thumbnail";
          img.loading = "lazy";

          const id = document.createElement("p");
          id.className = "video-id";
          id.textContent = video.task_id.slice(0, 8);

          card.appendChild(img);
          card.appendChild(id);

          card.addEventListener("click", () => {
            openPreview(video.task_id);
          });

          videoGrid.appendChild(card);

          // ✅ 여기서 썸네일 로딩
          loadThumbIntoImg(img, video.task_id);
        });

      } catch (err) {
        console.error(err);
        alert("영상 라이브러리를 불러오지 못했습니다.");
      }
    }

    // 2️⃣ 영상 미리보기 (스트리밍)
    async function openPreview(taskId) {
      try {
        const res = await fetch(`/api/video/stream/${taskId}`, {
          headers: { "Authorization": `Bearer ${token}` }
        });

        if (!res.ok) throw new Error("영상 재생 실패");

        const blob = await res.blob();
        const videoUrl = URL.createObjectURL(blob);

        const video = document.createElement("video");
        video.src = videoUrl;
        video.controls = true;
        video.autoplay = true;
        video.style.maxWidth = "90%";
        video.style.maxHeight = "90%";

        const modal = document.createElement("div");
        modal.style.position = "fixed";
        modal.style.top = 0;
        modal.style.left = 0;
        modal.style.right = 0;
        modal.style.bottom = 0;
        modal.style.background = "rgba(0,0,0,0.8)";
        modal.style.display = "flex";
        modal.style.alignItems = "center";
        modal.style.justifyContent = "center";
        modal.style.zIndex = 9999;

        modal.addEventListener("click", () => {
          URL.revokeObjectURL(videoUrl);
          modal.remove();
        });

        modal.appendChild(video);
        document.body.appendChild(modal);

      } catch (err) {
        console.error(err);
        alert("영상을 재생할 수 없습니다.");
      }
    }

    loadLibrary();
  </script>

</body>
</html>
