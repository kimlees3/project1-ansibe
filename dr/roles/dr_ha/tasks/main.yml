---
# roles/dr_ha/tasks/main.yml
#
# DR-HA (Patroni Replica) 구성
# 핵심 포인트
# 1) Patroni는 etcd v2(/v2)로 붙으면 404 → 반드시 etcd3: 사용 (템플릿 patroni.yml.j2에서 etcd3로 설정)
# 2) systemd ExecStart는 `command -v patroni` 경로와 일치해야 함 (203/EXEC 방지)
# 3) DR-HA는 initdb 하지 않고 basebackup으로 부트스트랩
# 4) pg_basebackup 인증 실패 방지: postgres 홈에 .pgpass + PGPASSFILE 환경변수 강제

- name: Disable OS postgresql module
  ansible.builtin.command: dnf -y module disable postgresql
  changed_when: false

- name: Clean dnf cache
  ansible.builtin.command: dnf clean all
  changed_when: false

- name: Make dnf cache
  ansible.builtin.command: dnf makecache
  changed_when: false

# ---- PGDG Repo + GPG Key ----
- name: Import PGDG GPG key
  ansible.builtin.rpm_key:
    state: present
    key: https://apt.postgresql.org/pub/repos/yum/keys/RPM-GPG-KEY-PGDG

# repo rpm 자체의 gpg signature 검증에서 계속 실패하는 환경이 있어 disable_gpg_check 사용
- name: Install PGDG repo (disable gpg check for repo rpm)
  ansible.builtin.dnf:
    name: https://download.postgresql.org/pub/repos/yum/reporpms/EL-9-x86_64/pgdg-redhat-repo-latest.noarch.rpm
    state: present
    disable_gpg_check: true

# ---- Packages ----
- name: Install PostgreSQL server + dependencies
  ansible.builtin.dnf:
    name:
      - "postgresql{{ pg_version }}"
      - "postgresql{{ pg_version }}-server"
      - python3-pip
      - python3-psycopg2
    state: present

- name: Install Patroni (pip)
  ansible.builtin.pip:
    name:
      - "patroni[etcd]"
      - psycopg2-binary
    state: present

# ---- Patroni binary path (203/EXEC 방지) ----
- name: Detect patroni executable path
  ansible.builtin.command: command -v patroni
  register: patroni_which
  changed_when: false

- name: Set patroni_bin fact
  ansible.builtin.set_fact:
    patroni_bin: "{{ patroni_which.stdout | trim }}"

# ---- Directories ----
- name: Ensure patroni config directory
  ansible.builtin.file:
    path: /etc/patroni
    state: directory
    owner: postgres
    group: postgres
    mode: '0755'

# NOTE: 실제 data_dir는 템플릿(patroni.yml.j2)과 pg_data_dir 변수가 일치해야 함
- name: Ensure postgres data directory exists (empty dir is OK)
  ansible.builtin.file:
    path: "{{ pg_data_dir }}"
    state: directory
    owner: postgres
    group: postgres
    mode: '0700'

# ---- patroni.yml ----
- name: Deploy DR-HA patroni.yml
  ansible.builtin.template:
    src: patroni.yml.j2
    dest: /etc/patroni/patroni.yml
    owner: postgres
    group: postgres
    mode: '0644'
  notify: Restart patroni

# ---- systemd unit ----
- name: Create systemd unit for Patroni (use detected ExecStart path)
  ansible.builtin.copy:
    dest: /etc/systemd/system/patroni.service
    mode: '0644'
    content: |
      [Unit]
      Description=Patroni PostgreSQL HA
      After=network.target

      [Service]
      User=postgres
      Group=postgres
      ExecStart={{ patroni_bin }} /etc/patroni/patroni.yml
      Restart=always
      RestartSec=3
      LimitNOFILE=10240

      [Install]
      WantedBy=multi-user.target

- name: Reload systemd after installing unit
  ansible.builtin.systemd:
    daemon_reload: true

# ---- .pgpass + PGPASSFILE ----
# pg_basebackup가 패스워드 물어보면 Patroni 부트스트랩이 계속 실패함
- name: Ensure postgres home exists
  ansible.builtin.file:
    path: /var/lib/pgsql
    state: directory
    owner: postgres
    group: postgres
    mode: '0755'

- name: Create pgpass files for postgres (both names)
  ansible.builtin.copy:
    dest: "{{ item }}"
    content: |
      10.1.5.10:5432:*:{{ patroni_replication_username }}:{{ patroni_replication_password }}
      10.1.5.20:5432:*:{{ patroni_replication_username }}:{{ patroni_replication_password }}
      10.1.5.30:5432:*:{{ patroni_replication_username }}:{{ patroni_replication_password }}
    owner: postgres
    group: postgres
    mode: '0600'
  loop:
    - /var/lib/pgsql/.pgpass
    - /var/lib/pgsql/pgpass


- name: Create systemd drop-in directory for patroni
  ansible.builtin.file:
    path: /etc/systemd/system/patroni.service.d
    state: directory
    mode: '0755'

- name: Configure patroni to use explicit PGPASSFILE
  ansible.builtin.copy:
    dest: /etc/systemd/system/patroni.service.d/10-pgpass.conf
    mode: '0644'
    content: |
      [Service]
      Environment="PGPASSFILE=/var/lib/pgsql/pgpass"

- name: Reload systemd after drop-in
  ansible.builtin.systemd:
    daemon_reload: true

# ---- Re-bootstrap (항상 새로 붙이기 원할 때 유용) ----
# 이미 데이터가 꼬여 있으면 계속 bootstrap 실패 → data_dir 지우고 다시 basebackup 받게 강제
- name: Stop patroni before re-bootstrap
  ansible.builtin.systemd:
    name: patroni
    state: stopped
  ignore_errors: true

- name: Remove data directory to force fresh bootstrap
  ansible.builtin.file:
    path: "{{ pg_data_dir }}"
    state: absent

- name: Recreate data directory
  ansible.builtin.file:
    path: "{{ pg_data_dir }}"
    state: directory
    owner: postgres
    group: postgres
    mode: '0700'

- name: Enable and start patroni
  ansible.builtin.systemd:
    name: patroni
    enabled: true
    state: started
