---
########################################
# 1. Repo 서버 기본 준비
########################################
- name: Prepare repo server base
  hosts: pgbackrest_repo
  gather_facts: false
  roles:
    - repo_base

########################################
# 2. pgBackRest repo 설치 및 설정
########################################
- name: Install and configure pgBackRest on repo
  hosts: pgbackrest_repo
  gather_facts: false
  roles:
    - pgbackrest_repo

- name: Setup pgBackRest repository server
  hosts: pgbackrest_repo
  become: true
  roles:
    - pgbackrest_textfile

########################################
# 3. DB ↔ Repo SSH trust 구성
########################################
- name: Configure SSH trust (DB <-> Repo)
  hosts: pgsql_db:pgbackrest_repo
  gather_facts: false
  roles:
    - pg_ssh_trust

########################################
# 4. Repo postgres known_hosts 준비 (중요)
########################################
- name: Prepare postgres known_hosts (Repo <-> DB)
  hosts: pgbackrest_repo:pgsql_db
  become: true
  roles:
    - pg_ssh_known_hosts


########################################
# 5. DB 노드 pgBackRest client 설정
########################################
- name: Configure pgBackRest client on DB nodes
  hosts: pgsql_db
  gather_facts: false
  roles:
    - pgbackrest_client

########################################
# 6. pgBackRest stanza 생성 (repo, idempotent)
########################################
- name: Create pgBackRest stanza on repo
  hosts: pgbackrest_repo
  gather_facts: false
  roles:
    - pgbackrest_stanza

########################################
# 7. pgBackRest full backup 실행 (repo)
########################################
- name: Run pgBackRest full backup on repo
  hosts: pgbackrest_repo
  gather_facts: false
  roles:
    - pgbackrest_backup
