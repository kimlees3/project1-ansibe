- name: Reset agents on all servers
  hosts: all
  become: true
  tasks:
    - name: Stop agent services (ignore if missing)
      systemd:
        name: "{{ item }}"
        state: stopped
      loop:
        - node_exporter
        - promtail
      ignore_errors: true

- name: Reset monitoring server components
  hosts: monitoring
  become: true
  tasks:
    - name: Stop monitoring services (ignore if missing)
      systemd:
        name: "{{ item }}"
        state: stopped
      loop:
        - prometheus
        - loki
        - grafana-server
      ignore_errors: true

    - name: Remove Prometheus data (optional)
      file:
        path: /var/lib/prometheus
        state: absent

    - name: Remove Loki data (optional)
      file:
        path: /var/lib/loki
        state: absent

    - name: Remove Promtail positions (optional)
      file:
        path: /var/lib/promtail/positions.yaml
        state: absent
